<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generador de Órdenes de Compra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
      .product-line {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.5rem;
        align-items: start;
      }
      .product-inputs {
        /* Adjusted grid columns to fit UMedida */
        display: grid;
        grid-template-columns: 3fr 1fr 0.5fr 1.5fr auto; 
        gap: 0.5rem;
        align-items: center;
      }
      /* Style for the totals preview */
       #totals-preview {
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem; /* p-4 */
            background-color: #f9fafb; /* gray-50 */
            margin-top: 1.5rem; /* mt-6 */
       }
       #totals-preview div {
           display: flex;
           justify-content: space-between;
           margin-bottom: 0.5rem; /* mb-2 */
           padding-bottom: 0.5rem; /* pb-2 */
           border-bottom: 1px solid #e5e7eb; /* border-b border-gray-200 */
       }
        #totals-preview div:last-child {
             margin-bottom: 0;
             padding-bottom: 0;
             border-bottom: none;
        }
       #totals-preview span:first-child {
           font-weight: 600; /* font-semibold */
           color: #4b5563; /* gray-600 */
       }
        #totals-preview span:last-child {
             font-weight: 700; /* font-bold */
             color: #1f2937; /* gray-800 */
        }
         #totals-preview div.total-final span:last-child {
             font-size: 1.125rem; /* text-lg */
         }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 font-sans">
    <div class="container mx-auto p-4 md:p-8">
      <header class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-black">
          Generador de Órdenes de Compra
        </h1>
        <p class="text-gray-800 mt-2">
          Completa el formulario para guardar el pedido en Google Sheets y
          generar el PDF.
        </p>
      </header>

      <div class="bg-white p-6 rounded-2xl shadow-lg mb-8 max-w-4xl mx-auto">
        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">
          Agregar Nuevo Pedido
        </h2>
        <form id="new-order-form">
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"
          >
            <div class="relative">
              <input
                type="text"
                name="razonSocial"
                id="razonSocial"
                placeholder="Razón Social"
                class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                required
                autocomplete="off"
              />
              <div
                id="client-autocomplete-list"
                class="absolute z-20 w-full bg-white border border-gray-300 rounded-b-lg mt-1 hidden max-h-60 overflow-y-auto"
              ></div>
            </div>
            <input
              type="text"
              name="rut"
              placeholder="RUT"
              class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <input
              type="text"
              name="giro"
              placeholder="Giro"
              class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <input
              type="text"
              name="direccion"
              placeholder="Dirección Cliente"
              class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <input
              type="text"
              name="fono"
              placeholder="Fono Cliente"
              class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <input
              type="text"
              name="nombreContacto"
              placeholder="Nombre Contacto"
              class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <input
              type="text"
              name="fonoCorreo"
              placeholder="Fono/Correo Contacto"
              class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <input
              type="date"
              name="fechaEntrega"
              title="Fecha de Entrega"
              class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
            <input
              type="text"
              name="transporte"
              placeholder="Transporte"
              class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <input
              type="text"
              name="autorizador"
              placeholder="Autorizado por"
              class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <input
              type="text"
              name="condicionesPago"
              placeholder="Cond. de Pago"
              class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div
            class="flex items-center gap-4 mb-4 p-4 bg-gray-50 rounded-lg border"
          >
            <label for="dollar-rate" class="font-semibold text-gray-600"
              >Valor Dólar (CLP):</label
            >
            <input
              type="number"
              id="dollar-rate"
              placeholder="Ej: 950.50"
              class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-40"
              step="any"
            />
          </div>

          <h3 class="text-xl font-semibold mb-2 mt-4 border-t pt-4">
            Productos
          </h3>
          <div id="product-lines-container" class="space-y-4">
            <!-- Product lines will be dynamically added here -->
          </div>
          <button
            type="button"
            id="add-product-btn"
            class="mt-2 bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition-colors duration-300"
          >
            + Agregar Producto
          </button>
          
           <!-- Totals Preview Section -->
           <div id="totals-preview" class="mt-6">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2">Vista Previa Totales</h3>
                <div>
                    <span>Subtotal Neto</span>
                    <span id="preview-subtotal">$ 0</span>
                </div>
                <div>
                    <span>19% IVA</span>
                    <span id="preview-iva">$ 0</span>
                </div>
                <div class="total-final">
                    <span>Total</span>
                    <span id="preview-total">$ 0</span>
                </div>
            </div>

          <div class="mt-6">
            <h3 class="text-xl font-semibold mb-2 mt-4 border-t pt-4">
              Observaciones
            </h3>
            <textarea
              name="observaciones"
              placeholder="Añadir observaciones a la orden de compra..."
              class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full h-24"
            ></textarea>
          </div>

          <div class="text-right mt-6">
            <button
              type="submit"
              id="submit-button"
              class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300"
            >
              Guardar Pedido y Generar PDF
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const productLinesContainer = document.getElementById(
        'product-lines-container'
      );
      const addProductBtn = document.getElementById('add-product-btn');
      const orderForm = document.getElementById('new-order-form');
      const submitButton = document.getElementById('submit-button');
      const dollarRateInput = document.getElementById('dollar-rate');

      const razonSocialInput = document.getElementById('razonSocial');
      const clientAutocompleteList = document.getElementById(
        'client-autocomplete-list'
      );
      
      // Elements for totals preview
      const previewSubtotalEl = document.getElementById('preview-subtotal');
      const previewIvaEl = document.getElementById('preview-iva');
      const previewTotalEl = document.getElementById('preview-total');


      let clientsWithData = [];
      let currentClientProducts = [];
      const googleWebAppUrl =
        'https://script.google.com/macros/s/AKfycby6dRXufxP2lVVn7S9SzmE_TMhji3l3IscJu-QnyYJjWC7Is-C7SOzxe7CsrziGTSRN7g/exec';

      // --- Autocomplete Logic ---
      async function fetchData() {
        try {
          const response = await fetch(googleWebAppUrl);
          if (!response.ok) throw new Error('Failed to fetch data');
          clientsWithData = await response.json();
        } catch (error) {
          console.error('Error fetching data for autocomplete:', error);
          alert(
            'No se pudo cargar la lista de clientes. Verifique la URL del script y que esté implementado.'
          );
        }
      }

      // Client Autocomplete
      razonSocialInput.addEventListener('input', () => {
        currentClientProducts = [];
        const inputText = razonSocialInput.value.toLowerCase();
        clientAutocompleteList.innerHTML = '';
        if (!inputText) {
          clientAutocompleteList.classList.add('hidden');
          return;
        }

        const suggestions = clientsWithData.filter((client) =>
          String(client.razonSocial).toLowerCase().includes(inputText)
        );

        if (suggestions.length > 0) {
          suggestions.forEach((suggestion) => {
            const div = document.createElement('div');
            div.textContent = suggestion.razonSocial;
            div.className = 'p-2 hover:bg-gray-200 cursor-pointer';
            div.addEventListener('click', () => {
              orderForm.razonSocial.value = suggestion.razonSocial;
              orderForm.rut.value = suggestion.rut;
              orderForm.giro.value = suggestion.giro;
              orderForm.direccion.value = suggestion.direccion;
              orderForm.fono.value = suggestion.fono;
              orderForm.nombreContacto.value = suggestion.nombreContacto;
              orderForm.fonoCorreo.value = suggestion.fonoCorreo;
              orderForm.transporte.value = suggestion.transporte;
              orderForm.autorizador.value = suggestion.autorizador;
              orderForm.condicionesPago.value = suggestion.condicionesPago;

              currentClientProducts = suggestion.products || [];
              clientAutocompleteList.classList.add('hidden');
            });
            clientAutocompleteList.appendChild(div);
          });
          clientAutocompleteList.classList.remove('hidden');
        } else {
          clientAutocompleteList.classList.add('hidden');
        }
      });

      // --- Update Totals Preview Function ---
      function updateTotalsPreview() {
          let subtotalGeneral = 0;
          const productLines = productLinesContainer.querySelectorAll('.product-line');
          productLines.forEach(line => {
              const cantidadInput = line.querySelector('[name="cantidad"]');
              const valorUnitarioInput = line.querySelector('[name="valorUnitario"]');
              const cantidad = parseFloat(cantidadInput.value) || 0;
              const valorUnitario = parseFloat(valorUnitarioInput.value) || 0;
              subtotalGeneral += cantidad * valorUnitario;
          });

          const iva = subtotalGeneral * 0.19;
          const totalFinal = subtotalGeneral + iva;

          previewSubtotalEl.textContent = `$ ${subtotalGeneral.toLocaleString('es-CL')}`;
          previewIvaEl.textContent = `$ ${iva.toLocaleString('es-CL')}`;
          previewTotalEl.textContent = `$ ${totalFinal.toLocaleString('es-CL')}`;
      }


      // --- Product Line Logic ---
      const addProductLine = () => {
        const productLineId = `product-line-${Date.now()}`;
        const productLineDiv = document.createElement('div');
        productLineDiv.className = 'product-line';
        productLineDiv.id = productLineId;

        // Added input for UMedida
        productLineDiv.innerHTML = `
                <div class="product-inputs">
                    <div class="relative w-full">
                        <input type="text" name="descripcion" placeholder="Descripción" class="p-2 border rounded-lg w-full description-input" required autocomplete="off">
                        <div class="absolute z-10 w-full bg-white border border-gray-300 rounded-b-lg mt-1 hidden max-h-48 overflow-y-auto product-autocomplete-list"></div>
                    </div>
                    <input type="number" name="cantidad" placeholder="Cantidad" class="p-2 border rounded-lg w-full" required step="any">
                    <input type="text" name="uMedida" placeholder="UM" class="p-2 border rounded-lg w-full"> 
                    <input type="number" name="valorUnitario" placeholder="Valor Unitario" class="p-2 border rounded-lg w-full" required step="any" title="Ingrese el valor en USD y luego presione 'a CLP'">
                    <button type="button" class="convert-price-btn bg-green-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-600 text-xs">a CLP</button>
                </div>
                <button type="button" class="remove-product-btn bg-red-500 text-white font-bold w-8 h-8 rounded-full hover:bg-red-600 mt-1">X</button>
            `;
        productLinesContainer.appendChild(productLineDiv);

        const descInput = productLineDiv.querySelector('.description-input');
        const prodAutocompleteList = productLineDiv.querySelector(
          '.product-autocomplete-list'
        );
        const cantidadInput = productLineDiv.querySelector('[name="cantidad"]');
        const valorUnitarioInput = productLineDiv.querySelector(
          '[name="valorUnitario"]'
        );
        const uMedidaInput = productLineDiv.querySelector('[name="uMedida"]'); // Get UMedida input

        // Add listeners to update totals on input change
        cantidadInput.addEventListener('input', updateTotalsPreview);
        valorUnitarioInput.addEventListener('input', updateTotalsPreview);


        descInput.addEventListener('input', () => {
          const inputText = descInput.value.toLowerCase();
          prodAutocompleteList.innerHTML = '';
          if (!inputText || currentClientProducts.length === 0) {
            prodAutocompleteList.classList.add('hidden');
            return;
          }

          const suggestions = currentClientProducts.filter((product) =>
            String(product.descripcion).toLowerCase().includes(inputText)
          );

          if (suggestions.length > 0) {
            suggestions.forEach((suggestion) => {
              const div = document.createElement('div');
              div.textContent = suggestion.descripcion;
              div.className = 'p-2 hover:bg-gray-200 cursor-pointer text-sm';
              div.addEventListener('click', () => {
                descInput.value = suggestion.descripcion;
                cantidadInput.value = suggestion.lastCantidad;
                uMedidaInput.value = suggestion.lastUMedida; // Autocomplete UMedida
                valorUnitarioInput.value = suggestion.lastValorUnitario;
                prodAutocompleteList.classList.add('hidden');
                updateTotalsPreview(); // Update totals after autocomplete
              });
              prodAutocompleteList.appendChild(div);
            });
            prodAutocompleteList.classList.remove('hidden');
          } else {
            prodAutocompleteList.classList.add('hidden');
          }
        });
        updateTotalsPreview(); // Update totals when a new line is added
      };

      document.addEventListener('click', function (e) {
        if (!e.target.closest('.relative')) {
          document
            .querySelectorAll(
              '.product-autocomplete-list, #client-autocomplete-list'
            )
            .forEach((list) => {
              list.classList.add('hidden');
            });
        }
      });

      document.addEventListener('DOMContentLoaded', fetchData);

      productLinesContainer.addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-product-btn')) {
          event.target.closest('.product-line').remove();
          updateTotalsPreview(); // Update totals when a line is removed
        }
        if (event.target.classList.contains('convert-price-btn')) {
          const dollarRate = parseFloat(dollarRateInput.value);
          if (isNaN(dollarRate) || dollarRate <= 0) {
            alert('Por favor, ingrese un valor de dólar válido.');
            dollarRateInput.focus();
            return;
          }
          const productInputs = event.target.closest('.product-inputs');
          const unitValueInput = productInputs.querySelector(
            '[name="valorUnitario"]'
          );
          const unitValueUSD = parseFloat(unitValueInput.value);
          if (isNaN(unitValueUSD)) {
            alert('Por favor, ingrese un valor unitario para convertir.');
            unitValueInput.focus();
            return;
          }
          unitValueInput.value = (unitValueUSD * dollarRate).toFixed(2);
          updateTotalsPreview(); // Update totals after conversion
        }
      });

      addProductBtn.addEventListener('click', addProductLine);
      addProductLine(); // Add the initial product line

      // --- Form Submission Logic ---
      orderForm.addEventListener('submit', async function (event) {
        event.preventDefault();
        submitButton.disabled = true;
        submitButton.innerText = 'Guardando...';

        const formData = new FormData(orderForm);
        const orderData = {
          fechaEmision: new Date().toISOString().split('T')[0],
          fechaEntrega: formData.get('fechaEntrega'),
          nombreContacto: formData.get('nombreContacto'),
          fonoCorreo: formData.get('fonoCorreo'),
          razonSocial: formData.get('razonSocial'),
          rut: formData.get('rut'),
          giro: formData.get('giro'),
          direccion: formData.get('direccion'),
          fono: formData.get('fono'),
          transporte: formData.get('transporte'),
          autorizador: formData.get('autorizador'),
          condicionesPago: formData.get('condicionesPago'),
          observaciones: formData.get('observaciones'),
        };

        const productsData = [];
        productLinesContainer
          .querySelectorAll('.product-line')
          .forEach((line) => {
            const descripcion = line.querySelector(
              '[name="descripcion"]'
            ).value;
            const cantidad = parseFloat(
              line.querySelector('[name="cantidad"]').value
            );
            const uMedida = line.querySelector('[name="uMedida"]').value; // Get UMedida value
            const valorUnitario = parseFloat(
              line.querySelector('[name="valorUnitario"]').value
            );
            // Include uMedida in validation and data push
            if (descripcion && !isNaN(cantidad) && uMedida && !isNaN(valorUnitario)) {
              productsData.push({ descripcion, cantidad, uMedida, valorUnitario });
            }
          });

        if (productsData.length === 0) {
          alert('Debes agregar al menos un producto válido (con UM).');
          submitButton.disabled = false;
          submitButton.innerText = 'Guardar Pedido y Generar PDF';
          return;
        }

        const payload = { ...orderData, products: productsData };

        try {
          const response = await fetch(googleWebAppUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload),
          });
          if (!response.ok) throw new Error(`Server error: ${response.status}`);
          const result = await response.json();
          if (result.status === 'success') {
            alert('¡Pedido guardado exitosamente en Google Sheets!');
            generatePDFFromData(payload, result.orderNumber);
            orderForm.reset();
            productLinesContainer.innerHTML = '';
            addProductLine(); // Add back one initial line
          } else {
            throw new Error(
              result.message || 'Google Script returned an error.'
            );
          }
        } catch (error) {
          console.error('Error saving to Google Sheets:', error);
          alert(
            `Hubo un error al guardar el pedido. Revisa las instrucciones y la consola para más detalles.`
          );
        } finally {
          submitButton.disabled = false;
          submitButton.innerText = 'Guardar Pedido y Generar PDF';
        }
      });

      // --- PDF Generation Logic ---
      function generatePDFFromData(orderData, orderNum = 'PENDIENTE') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // --- Header ---
        doc.setTextColor(0, 0, 0); // Set text color to black globally initially
        doc.setFontSize(17);
        doc.setFont('helvetica', 'bold');
        doc.text('PIETTRA SPA', 14, 20);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('RUT: 77.057.227-4', 14, 26);
        doc.text('Fabricación y Comercialización de Materiales para la Construcción', 14, 30);
        doc.text('Panamericana Norte 18.800, Lote 4', 14, 34);
        doc.text('Lampa Santiago', 14, 38);
        doc.text('Teléfono 9 9323 3304', 14, 42);
        
        doc.rect(130, 15, 65, 20);
        doc.setFontSize(17);
        doc.setFont('helvetica', 'bold');
        doc.text('ORDEN DE COMPRA', 133, 24);
        doc.setFontSize(15);
        doc.text(`N° ${orderNum}`, 153, 32);

        // --- Info Blocks ---
        let leftColumnY = 65;
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.text('EMITIDO PARA:', 14, leftColumnY);
        leftColumnY += 6;
        doc.setFont('helvetica', 'normal');
        
        const leftColumnMaxWidth = 90;

        doc.text(orderData.razonSocial, 14, leftColumnY);
        leftColumnY += 6;
        doc.text(`${orderData.rut || ''}`, 14, leftColumnY);
        leftColumnY += 6;

        if (orderData.direccion) {
            const direccionLines = doc.splitTextToSize(`${orderData.direccion}`, leftColumnMaxWidth);
            doc.text(direccionLines, 14, leftColumnY);
            leftColumnY += direccionLines.length * 5; 
        }

        doc.text(`${orderData.fono || ''}`, 14, leftColumnY);
        leftColumnY += 6;

        if (orderData.giro) {
            const giroLines = doc.splitTextToSize(`${orderData.giro}`, leftColumnMaxWidth);
            doc.text(giroLines, 14, leftColumnY);
            leftColumnY += giroLines.length * 5;
        }


        let yPos = 65;
        const detailsX = 120; 
        const valueX = 150; 
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.text('Emisión:', detailsX, yPos);
        doc.setFont('helvetica', 'normal');
        doc.text(orderData.fechaEmision, valueX, yPos);
        yPos += 6;
        doc.setFont('helvetica', 'bold');
        doc.text('Autorizado por:', detailsX, yPos);
        doc.setFont('helvetica', 'normal');
        doc.text(orderData.autorizador || '', valueX, yPos);
        yPos += 6;
        doc.setFont('helvetica', 'bold');
        doc.text('Transporte:', detailsX, yPos);
        doc.setFont('helvetica', 'normal');
        doc.text(orderData.transporte || '', valueX, yPos);
        yPos += 6;
        doc.setFont('helvetica', 'bold');
        doc.text('Cond. de pago:', detailsX, yPos);
        doc.setFont('helvetica', 'normal');
        doc.text(orderData.condicionesPago || '', valueX, yPos);
        yPos += 6;
        doc.setFont('helvetica', 'bold');
        doc.text('Contacto:', detailsX, yPos);
        doc.setFont('helvetica', 'normal');
        doc.text(orderData.nombreContacto || '', valueX, yPos);
        yPos += 6;
        doc.setFont('helvetica', 'bold');
        doc.text('Cel./Email:', detailsX, yPos);
        doc.setFont('helvetica', 'normal');
        doc.text(orderData.fonoCorreo || '', valueX, yPos);
        yPos += 6;
        doc.setFont('helvetica', 'bold');
        doc.text('Fecha entrega:', detailsX, yPos);
        doc.setFont('helvetica', 'normal');
        doc.text(orderData.fechaEntrega || '', valueX, yPos);

        // --- Products Table ---
        let subtotalGeneral = 0;
        const tableBody = orderData.products.map((item) => {
          const totalProducto = item.cantidad * item.valorUnitario;
          subtotalGeneral += totalProducto;
          // Added item.uMedida to the row data
          return [
            item.cantidad,
            item.uMedida, // New UM column data
            item.descripcion,
            `$ ${Number(item.valorUnitario).toLocaleString('es-CL')}`,
            `$ ${totalProducto.toLocaleString('es-CL')}`,
          ];
        });
        doc.autoTable({
          startY: Math.max(leftColumnY, yPos) + 10, 
          // Added 'UM' to the header
          head: [['Cant.', 'UM', 'Descripción', 'Valor Unit.', 'Precio']],
          body: tableBody,
          theme: 'grid',
          headStyles: {
            fillColor: [41, 128, 185], 
            textColor: 255,            
            fontStyle: 'bold',
          },
          styles: { fontSize: 9.5, cellPadding: 3, textColor: [0, 0, 0] },
          didParseCell: function(data) { 
              data.cell.styles.textColor = [0, 0, 0];
          },
          // Adjust column styles if needed to fit 'UM'
          columnStyles: {
            0: { cellWidth: 15 }, // CANT.
            1: { cellWidth: 14 }, // UM (New)
            2: { cellWidth: 'auto' }, // DESCRIPCION
            3: { cellWidth: 25 }, // VALOR UNIT.
            4: { cellWidth: 29 }  // PRECIO
          }
        });

        // --- Footer Section ---
        let finalY = doc.autoTable.previous.finalY;
        const footerStartY = finalY + 10;

        // --- Right Column: Totals ---
        const iva = subtotalGeneral * 0.19;
        const totalFinal = subtotalGeneral + iva;
        const totalsStartX = 125;
        const totalsBoxHeight = 20;
        doc.setFontSize(11);
        doc.text('Subtotal Neto', totalsStartX + 10, footerStartY + 4);
        doc.text(
          `$ ${subtotalGeneral.toLocaleString('es-CL')}`,
          totalsStartX + 60,
          footerStartY + 4,
          { align: 'right' }
        );
        doc.text('19% IVA', totalsStartX + 10, footerStartY + 10);
        doc.text(
          `$ ${iva.toLocaleString('es-CL')}`,
          totalsStartX + 60,
          footerStartY + 10,
          { align: 'right' }
        );
        doc.setFont('helvetica', 'bold');
        doc.text('Total', totalsStartX + 10, footerStartY + 16);
        doc.text(
          `$ ${totalFinal.toLocaleString('es-CL')}`,
          totalsStartX + 60,
          footerStartY + 16,
          { align: 'right' }
        );
        doc.rect(totalsStartX, footerStartY - 2, 65, totalsBoxHeight + 2);

        // --- Left Column: User Observations ---
        let observationsBoxHeight = 0;
        if (orderData.observaciones) {
          doc.setFontSize(9);
          doc.setFont('helvetica', 'bold');
          doc.text('OBSERVACIONES:', 14, footerStartY + 2); 
          doc.setFont('helvetica', 'normal');
          const obsLines = doc.splitTextToSize(orderData.observaciones, 105);
          const textHeight = obsLines.length * 4;
          observationsBoxHeight = textHeight + 12 > (totalsBoxHeight + 2) ? textHeight + 12 : (totalsBoxHeight + 2);
          doc.text(obsLines, 14, footerStartY + 7);
          doc.rect(12, footerStartY - 2, 110, observationsBoxHeight);
        }

        // --- Firmas ---
        const tallestBoxHeight = Math.max(
          observationsBoxHeight,
          (totalsBoxHeight + 2)
        );
        const firmasY = footerStartY + tallestBoxHeight + 20;
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.line(30, firmasY, 80, firmasY);
        doc.text('Firma Carlos Ortiz', 40, firmasY + 5);
        doc.line(120, firmasY, 170, firmasY);
        doc.text('Firma Rolf Hoppe', 130, firmasY + 5);

        // --- Static Observations ---
        const staticObsY = firmasY + 20;
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.text('OBSERVACIONES:', 14, staticObsY + 5); 
        doc.setFont('helvetica', 'normal');

        const staticText = [
          'CORREO DE FACTURACION ELECTRONICA: intercambio@skualodte.cl',
          'POR FAVOR CONFIRMAR RECEPCIÓN DE ESTE PEDIDO AL COMPRADOR/A',
          'Dirección de despacho: Panamericana Norte 18.800, Lote 4 Lampa Santiago',
          'Horario de recepción en bodega: Lunes a Jueves de 07:30 a 15:30, viernes de 07:30 a 14:30.',
          'Para entregas fueras de horario por favor contactar a su comprador.',
          'No se recibirán productos que no vengan con FACTURA y copia de la ORDEN de COMPRA correspondiente.',
          'No se permite el ingreso a planta Piettra Spa, sin Elementos de Protección Personal (EPP) (casco, zapato de seguridad y chaleco reflectante).',
          'En el caso de transportistas de productos químicos, estos deben contar con elementos de control de derrames y extintor.',
        ];

        let currentY = staticObsY + 10;
        let totalStaticTextHeight = 0;
        staticText.forEach((line) => {
          const splitLines = doc.splitTextToSize(line, 180);
          doc.text(splitLines, 14, currentY); 
          const blockHeight = splitLines.length * 4;
          currentY += blockHeight;
          totalStaticTextHeight += blockHeight;
        });

        const staticBoxHeight = totalStaticTextHeight + 8;
        doc.rect(12, staticObsY, 186, staticBoxHeight);

        const clientNameForFile = orderData.razonSocial
            .split(' ')[0]
            .toLowerCase()
            .replace(/[^a-z0-9]/gi, '');
            
        doc.save(`OC_${orderNum}_${clientNameForFile}.pdf`);
      }
    </script>
  </body>
</html>

